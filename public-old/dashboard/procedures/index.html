<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procedures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../toast.js" defer></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        .modal-dialog.modal-dialog-centered {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Hide number input spinners for all browsers */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
    <style>
        .tooth-surface-checkboxes {
            position: relative;
            width: 55px;
            height: 55px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid #222;
            background: #fff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.07);
        }

        .surface-checkbox {
            position: absolute;
            margin: 0;
            width: 16px;
            height: 16px;
            accent-color: #2563eb;
            background: #f4f6fa;
            border-radius: 3px;
            border: 1px solid #b4b4d8;
            cursor: pointer;
            z-index: 2;
        }

        .surface-top {
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
        }

        .surface-bottom {
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
        }

        .surface-left {
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
        }

        .surface-right {
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
        }

        .surface-center {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
        }
    </style>
</head>

<body style="height: 100%;" id="patients-page">

    <div class="container mt-4">
        <div class="row mb-2">
            <div class="col-12 d-flex gap-2 justify-content-between align-items-center">
                <h2>Procedures List</h2>
                <div class="input-group" style="max-width: 400px; margin-left: auto;">
                    <input type="text" class="form-control" id="searchPatientInput"
                        placeholder="Search by patient name..." list="patientNamesDatalist">
                    <button type="button" class="btn btn-primary" id="searchPatientBtn">Search</button>
                </div>
                <button type="button" class="btn btn-primary" id="newProcedureBtn">New Procedure</button>
                <button type="button" class="btn btn-primary py-2 px-3" id="reloadProceduresBtn"
                    title="Reload Procedures" style="height: 38px;">
                    <i class="fa fa-rotate-right"></i>
                </button>
            </div>
        </div>
        <div class="card shadow-sm">
            <!-- <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Procedures Done to Patients</h4>
            </div> -->
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Patient Name</th>
                                <th>Procedure</th>
                                <th>Amount</th>
                                <th>Doctor</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="proceduresList">
                            <!-- Procedure rows will be rendered here by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <nav aria-label="Procedures pagination" class="mt-3">
                    <ul class="pagination justify-content-center" id="proceduresPagination" style="gap: 8px;">
                        <li class="page-item">
                            <button class="page-link rounded-pill px-4" id="prevPageBtn">Prev</button>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link rounded-pill bg-primary text-white px-4" id="pageInfo">Page 1</span>
                        </li>
                        <li class="page-item">
                            <button class="page-link rounded-pill px-4" id="nextPageBtn">Next</button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <!-- Add Procedure Modal -->
    <div class="modal fade" id="addProcedureModal" tabindex="-1" aria-labelledby="addProcedureModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="min-width:900px;">

                <div class="modal-header">
                    <!-- <button id="testButton">click me</button> -->
                    <!-- <h5 class="modal-title" id="addProcedureModalLabel">Add Procedure Done to Patient</h5> -->
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        id="closeAddProcedureModalBtn"></button>
                </div>
                <div class="modal-body">
                    <form id="addProcedureForm">
                        <div style="display: flex; gap: 24px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 0;">
                                <div class="mb-3">
                                    <label for="patientName" class="form-label">Patient Name</label>
                                    <input type="text" class="form-control" id="patientName" name="patientName"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <label for="procedure" class="form-label">Procedure</label>
                                    <select class="form-select" id="procedure" name="procedure" required>
                                        <option value="">Select Procedure</option>
                                        <optgroup label="Surgical Procedures">
                                            <option>Frenectomy (lip or tongue tie release)</option>
                                            <option>Biopsy of oral lesions</option>
                                            <option>Cyst or tumor removal</option>
                                            <option>Corrective jaw surgery (orthognathic surgery)</option>
                                        </optgroup>
                                        <optgroup label="Orthodontic Procedures">
                                            <option>Braces (metal, ceramic, lingual)</option>
                                            <option>Clear aligners (e.g., Invisalign)</option>
                                            <option>Space maintainers (for children)</option>
                                            <option>Retainers (post-braces)</option>
                                            <option>Interceptive orthodontics (for early correction)</option>
                                        </optgroup>
                                        <optgroup label="Cosmetic Dentistry">
                                            <option>Teeth whitening (in-office or take-home)</option>
                                            <option>Veneers (porcelain or composite)</option>
                                            <option>Smile makeovers</option>
                                            <option>Gum contouring (reshaping gum line)</option>
                                            <option>Composite bonding for aesthetic improvement</option>
                                        </optgroup>
                                        <optgroup label="Prosthodontics / Full Mouth Rehabilitation">
                                            <option>Full-mouth reconstructions</option>
                                            <option>Implant-supported dentures or bridges</option>
                                            <option>Occlusal adjustments and bite rehabilitation</option>
                                        </optgroup>
                                        <optgroup label="Emergency Dental Care">
                                            <option>Treatment for dental trauma (fractured or knocked-out teeth)
                                            </option>
                                            <option>Pain management (infections, abscesses)</option>
                                            <option>Temporary restorations</option>
                                            <option>Draining oral infections or abscesses</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="doctor" class="form-label">Doctor</label>
                                    <input itemid="doctorList" type="text" class="form-control" id="doctor"
                                        name="doctor" required list="doctorNamesDatalist">
                                </div>
                                <div class="mb-3">
                                    <label for="date" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="date" name="date" required max="">

                                </div>
                                <div class="mb-3">
                                    <label for="remarks" class="form-label">Remarks</label>
                                    <textarea class="form-control" id="remarks" name="remarks" rows="3"
                                        required></textarea>
                                </div>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div class="mb-3">
                                    <label class="form-label">Teeth Treated</label>
                                    <div class="container text-center">
                                        <div class="row">
                                            <!-- Loop teeth 11 to 18 -->
                                            <div class="col p-1">
                                                <div class="d-flex justify-content-center align-items-center position-relative border rounded-circle"
                                                    style="width: 50px; height: 50px;">
                                                    <!-- Top -->
                                                    <input type="checkbox"
                                                        class="form-check-input position-absolute p-0 m-0"
                                                        style="top: 2px; left: 50%; transform: translateX(-50%) scale(0.6);"
                                                        title="Top">
                                                    <!-- Left -->
                                                    <input type="checkbox"
                                                        class="form-check-input position-absolute p-0 m-0"
                                                        style="left: 2px; top: 50%; transform: translateY(-50%) scale(0.6);"
                                                        title="Left">
                                                    <!-- Center -->
                                                    <input type="checkbox"
                                                        class="form-check-input position-absolute p-0 m-0"
                                                        style="top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.6);"
                                                        title="Center">
                                                    <!-- Right -->
                                                    <input type="checkbox"
                                                        class="form-check-input position-absolute p-0 m-0"
                                                        style="right: 2px; top: 50%; transform: translateY(-50%) scale(0.6);"
                                                        title="Right">
                                                    <!-- Bottom -->
                                                    <input type="checkbox"
                                                        class="form-check-input position-absolute p-0 m-0"
                                                        style="bottom: 2px; left: 50%; transform: translateX(-50%) scale(0.6);"
                                                        title="Bottom">
                                                </div>
                                                <small>11</small>
                                            </div>

                                            <div class="col p-1">
                                                <div class="d-flex justify-content-center align-items-center position-relative border rounded-circle"
                                                    style="width: 50px; height: 50px;">
                                                    <!-- checkboxes here same as above -->
                                                </div>
                                                <small>12</small>
                                            </div>

                                            <!-- Repeat col for 13â€“18 -->
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="form-group">
                                            <label for="procedureAmount">Amount</label>
                                            <div class="input-group">
                                                <span class="input-group-text" id="peso-addon"><i
                                                        class="fa fa-peso-sign"></i></span>
                                                <input type="number" class="form-control" id="procedureAmount" required
                                                    placeholder="Enter amount" min="1" aria-describedby="peso-addon">
                                            </div>
                                            <label for="procedureBalance">Balance</label>
                                            <div class="input-group">
                                                <span class="input-group-text" id="peso-addon"><i
                                                        class="fa fa-peso-sign"></i></span>
                                                <input type="number" class="form-control" id="procedureBalance"
                                                    placeholder="Enter balance" min="0" aria-describedby="peso-addon">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Add Procedure</button>
                        <button type="button" class="btn btn-secondary w-100 mt-2 d-none"
                            id="editProcedureBtn">Edit</button>
                        <button type="button" class="btn btn-success w-100 mt-2 d-none"
                            id="updateProcedureBtn">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/app.js" defer></script>
    <script>


        document.addEventListener('DOMContentLoaded', function () {
            const reloadBtn = document.getElementById('reloadProceduresBtn');
            if (reloadBtn) {
                reloadBtn.addEventListener('click', function () {
                    location.reload();
                });
            }
        });

        // document.getElementById('testButton').addEventListener('click', function () {
        //     console.log('Button clicked!');
        //     console.log('Amount:', amount.value);
        //     console.log('Balance:', balance.value);
        // });
    </script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const amount = document.getElementById('procedureAmount');
            const balance = document.getElementById('procedureBalance');
            // Pagination variables
            let proceduresData = [];
            let currentPage = 1;
            const pageSize = 10;
            let totalPages = 1;

            // Fetch all procedures and store in array
            function fetchProcedures() {
                if (window.proceduresCollection) {
                    window.proceduresCollection.orderBy('date', 'desc').get().then(snapshot => {
                        proceduresData = [];
                        snapshot.forEach(doc => {
                            const p = doc.data();
                            proceduresData.push({ id: doc.id, ...p });
                        });
                        totalPages = Math.max(1, Math.ceil(proceduresData.length / pageSize));
                        renderProceduresTable();
                        updatePaginationControls();
                    });
                }
            }

            // Render current page of procedures
            function renderProceduresTable() {
                const proceduresList = document.getElementById('proceduresList');
                proceduresList.innerHTML = '';
                const startIdx = (currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, proceduresData.length);
                for (let i = startIdx; i < endIdx; i++) {
                    const p = proceduresData[i];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.patientName || ''}</td>
                        <td>${p.procedure || ''}</td>
                        <td>${p.amount || ''}</td>
                        <td>${p.doctor || ''}</td>
                        <td>${p.date || ''}</td>
                        <td><button class="btn btn-outline-primary btn-sm view-procedure-btn" data-id="${p.id}">View</button></td>
                    `;
                    proceduresList.appendChild(row);
                }
            }

            // Update pagination controls
            function updatePaginationControls() {
                const pageInfo = document.getElementById('pageInfo');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            }

            // Pagination button events
            document.getElementById('prevPageBtn').addEventListener('click', function () {
                if (currentPage > 1) {
                    currentPage--;
                    renderProceduresTable();
                    updatePaginationControls();
                }
            });
            document.getElementById('nextPageBtn').addEventListener('click', function () {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderProceduresTable();
                    updatePaginationControls();
                }
            });

            fetchProcedures();

            // Add Procedure Modal logic
            document.getElementById('newProcedureBtn').setAttribute('data-bs-toggle', 'modal');
            document.getElementById('newProcedureBtn').setAttribute('data-bs-target', '#addProcedureModal');
            const addProcedureForm = document.getElementById('addProcedureForm');
            const addBtn = addProcedureForm.querySelector('button[type="submit"]');
            const editBtn = document.getElementById('editProcedureBtn');
            const updateBtn = document.getElementById('updateProcedureBtn');
            let currentProcedureId = null;

            // Helper to set all form fields disabled/enabled
            function setFormDisabled(disabled) {
                addProcedureForm.querySelectorAll('input, select').forEach(el => {
                    el.disabled = disabled;
                });
                // Checkboxes
                addProcedureForm.querySelectorAll('input[type="checkbox"]').forEach(el => {
                    el.disabled = disabled;
                });
            }

            // Helper to reset modal to add mode
            function resetModalToAddMode() {
                addProcedureForm.reset();
                setFormDisabled(false);
                addBtn.classList.remove('d-none');
                editBtn.classList.add('d-none');
                updateBtn.classList.add('d-none');
                currentProcedureId = null;
            }

            // When Add Procedure modal is shown, reset to add mode
            document.getElementById('addProcedureModal').addEventListener('show.bs.modal', function (e) {
                if (!currentProcedureId) {
                    resetModalToAddMode();
                }
            });

            // View button logic
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('view-procedure-btn')) {
                    const id = e.target.getAttribute('data-id');
                    if (window.proceduresCollection && id) {
                        window.proceduresCollection.doc(id).get().then(doc => {
                            if (doc.exists) {
                                const p = doc.data();
                                // Fill form fields
                                addProcedureForm.patientName.value = p.patientName || '';
                                addProcedureForm.procedure.value = p.procedure || '';
                                addProcedureForm.doctor.value = p.doctor || '';
                                addProcedureForm.date.value = p.date || '';
                                addProcedureForm.remarks.value = p.remarks || '';
                                addProcedureForm.procedureAmount.value = p.amount || '';
                                addProcedureForm.procedureBalance.value = p.balance || '';
                                // Uncheck all teeth first
                                addProcedureForm.querySelectorAll('input[name="teeth[]"]').forEach(cb => {
                                    cb.checked = false;
                                });
                                if (Array.isArray(p.treatedTeeth)) {
                                    p.treatedTeeth.forEach(val => {
                                        const cb = addProcedureForm.querySelector('input[name="teeth[]"][value="' + val + '"]');
                                        if (cb) cb.checked = true;
                                    });
                                }
                                setFormDisabled(true);
                                addBtn.classList.add('d-none');
                                editBtn.classList.remove('d-none');
                                updateBtn.classList.add('d-none');
                                currentProcedureId = id;
                                // Show modal
                                const modalEl = document.getElementById('addProcedureModal');
                                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modalInstance.show();
                            }
                        });
                    }
                }
            });

            // Edit button logic
            editBtn.addEventListener('click', function () {
                setFormDisabled(false);
                addBtn.classList.add('d-none');
                editBtn.classList.add('d-none');
                updateBtn.classList.remove('d-none');
            });

            // Update button logic
            updateBtn.addEventListener('click', function () {
                if (!currentProcedureId) return;
                if (confirm('Are you sure you want to update this procedure?')) {
                    // Collect treated teeth
                    const treatedTeeth = Array.from(document.querySelectorAll('input[name="teeth[]"]:checked')).map(input => input.value);
                    // Find patientId if available (assumes datalist option value="name" data-id="id")
                    let patientId = null;
                    const patientNameInput = document.getElementById('patientName');
                    const patientName = patientNameInput.value;
                    const datalist = document.getElementById('patientNamesDatalist');
                    if (datalist) {
                        const option = Array.from(datalist.options).find(opt => opt.value === patientName);
                        if (option && option.dataset.id) {
                            patientId = option.dataset.id;
                        }
                    }
                    const procedureData = {
                        patientName: patientName,
                        patientId: patientId,
                        procedure: document.getElementById('procedure').value,
                        doctor: document.getElementById('doctor').value,
                        date: document.getElementById('date').value,
                        remarks: document.getElementById('remarks').value.trim(),
                        amount: amount.value,
                        balance: balance.value,
                        treatedTeeth: treatedTeeth
                    };
                    if (window.proceduresCollection) {
                        window.proceduresCollection.doc(currentProcedureId).update(procedureData)
                            .then(() => {
                                setFormDisabled(true);
                                addBtn.classList.add('d-none');
                                editBtn.classList.remove('d-none');
                                updateBtn.classList.add('d-none');
                                showSuccess('Procedure updated for ' + procedureData.patientName);
                                fetchProcedures(); // Refresh table and pagination
                                addProcedureForm.reset();
                                currentProcedureId = null;
                                // Close modal
                                const modalEl = document.getElementById('addProcedureModal');
                                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modalInstance.hide();
                            })
                            .catch((error) => {
                                showError('Error updating procedure: ' + error);
                            });
                    }
                }
            });

            // Add Procedure logic (unchanged)
            if (addProcedureForm) {
                addProcedureForm.onsubmit = function (e) {
                    e.preventDefault();
                    // Verify patient name
                    const patientNameInput = document.getElementById('patientName');
                    const patientName = patientNameInput.value.trim(); // keep original case
                    const patientDatalist = document.getElementById('patientNamesDatalist');
                    const patientMatches = patientDatalist ? Array.from(patientDatalist.options).filter(opt => opt.value.trim().toLowerCase() === patientName.toLowerCase()) : [];
                    if (!patientName || patientMatches.length === 0) {
                        showWarning('Please select a valid patient name from the list.');
                        patientNameInput.focus();
                        return;
                    }
                    // Verify doctor name
                    const doctorInput = document.getElementById('doctor');
                    const doctorName = doctorInput.value.trim(); // keep original case
                    const doctorDatalist = document.getElementById('doctorNamesDatalist');
                    const doctorMatches = doctorDatalist ? Array.from(doctorDatalist.options).filter(opt => opt.value.trim().toLowerCase() === doctorName.toLowerCase()) : [];
                    if (!doctorName || doctorMatches.length === 0) {
                        showWarning('Please select a valid doctor name from the list.');
                        doctorInput.focus();
                        return;
                    }
                    if (confirm('Are you sure you want to add this procedure?')) {
                        // Collect treated teeth
                        const treatedTeeth = Array.from(document.querySelectorAll('input[name="teeth[]"]:checked')).map(input => input.value);
                        // Find patientId if available (assumes datalist option value="name" data-id="id")
                        let patientId = null;
                        const remarks = document.getElementById('remarks').value.trim();
                        if (patientDatalist) {
                            // Find all options that match the input value (case-insensitive, trimmed)
                            if (patientMatches.length >= 1 && patientMatches[0].dataset.id) {
                                patientId = patientMatches[0].dataset.id;
                            }
                        }
                        const procedureData = {
                            patientName: patientName, // original case
                            patientId: patientId,
                            procedure: document.getElementById('procedure').value,
                            doctor: doctorInput.value, // original case
                            date: document.getElementById('date').value,
                            remarks: remarks,
                            amount: amount.value,
                            balance: balance.value,
                            treatedTeeth: treatedTeeth
                        };
                        if (window.proceduresCollection) {

                            window.proceduresCollection.add(procedureData)
                                .then(() => {
                                    setFormDisabled(true);
                                    addBtn.classList.add('d-none');
                                    editBtn.classList.remove('d-none');
                                    updateBtn.classList.add('d-none');
                                    showSuccess('Procedure added for ' + procedureData.patientName);
                                    location.reload();
                                    fetchProcedures(); // Refresh table and pagination
                                    addProcedureForm.reset();
                                    currentProcedureId = null;
                                    // Close modal
                                    const modalEl = document.getElementById('addProcedureModal');
                                    const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                    modalInstance.hide();
                                })
                                .catch((error) => {
                                    showError('Error adding procedure: ' + error);
                                });
                        }
                    }
                };
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ...existing code...
            // Reset modal form when close button is clicked
            document.getElementById('closeAddProcedureModalBtn').addEventListener('click', function () {
                const addProcedureForm = document.getElementById('addProcedureForm');
                if (addProcedureForm) {
                    addProcedureForm.reset();
                    // Uncheck all teeth checkboxes
                    addProcedureForm.querySelectorAll('input[name="teeth[]"]').forEach(cb => { cb.checked = false; });
                    // Optionally, reset disabled state if needed
                    addProcedureForm.querySelectorAll('input, select, textarea').forEach(el => { el.disabled = false; });
                    // Hide edit/update buttons, show add button
                    document.getElementById('editProcedureBtn').classList.add('d-none');
                    document.getElementById('updateProcedureBtn').classList.add('d-none');
                    addProcedureForm.querySelector('button[type="submit"]').classList.remove('d-none');
                }
            });

            // Pagination variables
            let proceduresData = [];
            let currentPage = 1;
            const pageSize = 10;
            let totalPages = 1;



            // Redone search logic: use patient name input to get patientId from datalist, then filter procedures by patientId
            document.getElementById('searchPatientBtn').addEventListener('click', function () {
                const searchInput = document.getElementById('searchPatientInput').value.trim();
                const datalist = document.getElementById('patientNamesDatalist');
                const proceduresList = document.getElementById('proceduresList');
                proceduresList.innerHTML = '';
                if (!searchInput) {
                    showWarning('Please enter or select a patient name.');
                    document.getElementById('searchPatientInput').focus();
                    return;
                }
                // Get patient doc id from datalist (exact match)
                const match = datalist ? Array.from(datalist.options).find(opt => opt.value === searchInput) : null;
                const patientId = match ? match.dataset.id : null;
                if (!patientId) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" class="text-center text-danger">No procedure found for <strong>${searchInput}</strong> (patient not found)</td>`;
                    proceduresList.appendChild(row);
                    document.getElementById('pageInfo').textContent = 'Results: 0';
                    document.getElementById('prevPageBtn').disabled = true;
                    document.getElementById('nextPageBtn').disabled = true;
                    return;
                }
                // Fetch procedures from Firestore using patientId
                window.proceduresCollection.where('patientId', '==', patientId).get().then(snapshot => {
                    const filtered = [];
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        filtered.push({ id: doc.id, ...p });
                    });
                    if (filtered.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="5" class="text-center text-danger">No procedure found for <strong>${searchInput}</strong></td>`;
                        proceduresList.appendChild(row);
                    } else {
                        filtered.forEach(p => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${p.patientName || ''}</td>
                                <td>${p.procedure || ''}</td>
                                <td>${p.amount || ''}</td>
                                <td>${p.doctor || ''}</td>
                                <td>${p.date || ''}</td>
                                <td><button class="btn btn-outline-primary btn-sm view-procedure-btn" data-id="${p.id}">View</button></td>
                            `;
                            proceduresList.appendChild(row);
                        });
                    }
                    // Update pagination info to show filtered count
                    document.getElementById('pageInfo').textContent = `Results: ${filtered.length}`;
                    document.getElementById('prevPageBtn').disabled = true;
                    document.getElementById('nextPageBtn').disabled = true;
                });
            });

            // Set max date for procedure date input to today
            var dateInput = document.getElementById('date');
            if (dateInput) {
                var today = new Date();
                var yyyy = today.getFullYear();
                var mm = String(today.getMonth() + 1).padStart(2, '0');
                var dd = String(today.getDate()).padStart(2, '0');
                var maxDate = yyyy + '-' + mm + '-' + dd;
                dateInput.setAttribute('max', maxDate);
            }
        });
    </script>
</body>

</html>