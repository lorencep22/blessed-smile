<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>

<body style="height: 100%;" id="patients-page">

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Doctors</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#doctorModal">
                Add Doctor
            </button>
        </div>
        <div id="doctorsList"></div>
        <!-- Modal -->
        <div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="doctorModalLabel">Doctor Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <form id="addDoctorForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doctorName" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="doctorName" name="doctorName"
                                            required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorLicense" class="form-label">License No.</label>
                                        <input type="text" class="form-control" id="doctorLicense" name="doctorLicense"
                                            required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorPtrNo" class="form-label">PTR No.</label>
                                        <input type="text" class="form-control" id="doctorPtrNo" name="doctorPtrNo"
                                            required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorGender" class="form-label">Gender</label>
                                        <select class="form-select" id="doctorGender" name="doctorGender" required>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doctorPosition" class="form-label">Position</label>
                                        <input type="text" class="form-control" id="doctorPosition"
                                            name="doctorPosition" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorStatus" class="form-label">Status</label>
                                        <select class="form-select" id="doctorStatus" name="doctorStatus" required>
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Add Doctor</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="  /app.js" defer></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            // Fetch and render doctors table with pagination
            function renderDoctorsTable(page = 1) {
                if (window.doctorsCollection) {
                    window.doctorsCollection.get().then(snapshot => {
                        const doctors = [];
                        snapshot.forEach(doc => {
                            const d = doc.data();
                            d.id = doc.id;
                            doctors.push(d);
                        });
                        const pageSize = 15;
                        const totalPages = Math.ceil(doctors.length / pageSize);
                        page = Math.max(1, Math.min(page, totalPages));
                        let html = `<table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>License No.</th>
                                    <th>PTR NO.</th>
                                    <th>Position</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>`;
                        const start = (page - 1) * pageSize;
                        const end = Math.min(start + pageSize, doctors.length);
                        for (let i = start; i < end; i++) {
                            const d = doctors[i];
                            html += `<tr>
                                <td>${d.name || ''}</td>
                                <td>${d.licenseNo || ''}</td>
                                <td>${d.ptrNo || ''}</td>
                                <td>${d.position || ''}</td>
                                <td>${d.status || 'Active'}</td>
                                <td><button class="btn btn-outline-primary btn-sm" onclick="editDoctor('${d.id}')">Edit</button></td>
                            </tr>`;
                        }
                        html += `</tbody></table>`;
                        // Pagination controls (numbered, centered)
                        html += `<nav aria-label="Doctors pagination" class="mt-3">
                                                    <ul class="pagination justify-content-center" style="gap: 8px;">`;
                        html += `<li class="page-item">
                                                    <button class="page-link rounded-pill px-4" id="prevPageBtn">Prev</button>
                                                </li>`;
                        html += `<li class="page-item disabled">
                                                    <span class="page-link rounded-pill bg-primary text-white px-4" id="pageInfo">Page ${page} of ${totalPages || 1}</span>
                                                </li>`;
                        html += `<li class="page-item">
                                                    <button class="page-link rounded-pill px-4" id="nextPageBtn">Next</button>
                                                </li>`;
                        html += `</ul></nav>`;
                        document.getElementById('doctorsList').innerHTML = html;
                        // Add click event for numbered pagination
                        // Add click event for pill-style pagination
                        const prevBtn = document.querySelector('#doctorsList #prevPageBtn');
                        const nextBtn = document.querySelector('#doctorsList #nextPageBtn');
                        prevBtn.disabled = page === 1;
                        nextBtn.disabled = page === totalPages || totalPages === 0;
                        prevBtn.onclick = function (e) {
                            e.preventDefault();
                            if (page > 1) renderDoctorsTable(page - 1);
                        };
                        nextBtn.onclick = function (e) {
                            e.preventDefault();
                            if (page < totalPages) renderDoctorsTable(page + 1);
                        };
                    });
                }
            }
            renderDoctorsTable();

            // Add doctor form submit logic
            const addDoctorForm = document.getElementById('addDoctorForm');
            if (addDoctorForm) {
                addDoctorForm.onsubmit = function (e) {
                    e.preventDefault();
                    function toPascalCase(str) {
                        return str.replace(/\w+/g, function (word) {
                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        });
                    }
                    const rawName = document.getElementById('doctorName').value.trim();
                    const rawLicense = document.getElementById('doctorLicense').value.trim();
                    const rawPtrNo = document.getElementById('doctorPtrNo').value.trim();
                    const gender = document.getElementById('doctorGender').value;
                    const pascalName = toPascalCase(rawName);
                    const prefix = gender === 'Female' ? 'Dra. ' : 'Dr. ';
                    const doctor = {
                        name: pascalName.startsWith(prefix) ? pascalName : prefix + pascalName,
                        licenseNo: rawLicense,
                        ptrNo: rawPtrNo,
                        gender: gender,
                        position: document.getElementById('doctorPosition').value,
                        status: document.getElementById('doctorStatus').value
                    };
                    if (window.doctorsCollection) {
                        window.doctorsCollection.add(doctor)
                            .then(() => {
                                alert('Doctor added successfully!');
                                addDoctorForm.reset();
                                // Hide modal
                                const modalEl = document.getElementById('doctorModal');
                                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modalInstance.hide();
                                location.reload();
                            })
                            .catch((error) => {
                                alert('Error adding doctor: ' + error);
                            });
                    }
                };
                // When modal is closed, restore Add button and remove Update button if present
                document.getElementById('doctorModal').addEventListener('hidden.bs.modal', function () {
                    let addBtn = document.querySelector('#addDoctorForm button[type="submit"]');
                    let updateBtn = document.getElementById('updateDoctorBtn');
                    if (addBtn) addBtn.style.display = 'block';
                    if (updateBtn) updateBtn.remove();
                    addDoctorForm.reset();
                });
            }
        });

        // Edit doctor logic
        function editDoctor(id) {
            if (!window.doctorsCollection) return;
            window.doctorsCollection.doc(id).get().then(doc => {
                if (!doc.exists) {
                    alert('Doctor not found!');
                    return;
                }
                const d = doc.data();
                // Populate modal fields
                document.getElementById('doctorName').value = d.name ? d.name.replace(/^Dr\.?\s*|^Dra\.?\s*/i, '') : '';
                document.getElementById('doctorLicense').value = d.licenseNo || '';
                document.getElementById('doctorGender').value = d.gender || 'Male';
                document.getElementById('doctorPosition').value = d.position || '';
                document.getElementById('doctorStatus').value = d.status || 'Active';
                document.getElementById('doctorPtrNo').value = d.ptrNo || '';
                // Show Update button, hide Add button
                let addBtn = document.querySelector('#addDoctorForm button[type="submit"]');
                let updateBtn = document.getElementById('updateDoctorBtn');
                if (!updateBtn) {
                    updateBtn = document.createElement('button');
                    updateBtn.id = 'updateDoctorBtn';
                    updateBtn.type = 'button';
                    updateBtn.className = 'btn btn-success w-100 mt-2';
                    updateBtn.textContent = 'Update Doctor';
                    updateBtn.onclick = function () {
                        function toPascalCase(str) {
                            return str.replace(/\w+/g, function (word) {
                                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                            });
                        }
                        const rawName = document.getElementById('doctorName').value.trim();
                        const gender = document.getElementById('doctorGender').value;
                        const pascalName = toPascalCase(rawName);
                        const prefix = gender === 'Female' ? 'Dra. ' : 'Dr. ';
                        const updatedDoctor = {
                            name: pascalName.startsWith(prefix) ? pascalName : prefix + pascalName,
                            licenseNo: document.getElementById('doctorLicense').value.trim(),
                            ptrNo: document.getElementById('doctorPtrNo').value.trim(),
                            gender: gender,
                            position: document.getElementById('doctorPosition').value,
                            status: document.getElementById('doctorStatus').value
                        };
                        window.doctorsCollection.doc(id).update(updatedDoctor)
                            .then(() => {
                                alert('Doctor updated successfully!');
                                document.getElementById('addDoctorForm').reset();
                                // Hide modal
                                const modalEl = document.getElementById('doctorModal');
                                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modalInstance.hide();
                                // Restore buttons
                                updateBtn.remove();
                                addBtn.style.display = 'block';
                                location.reload();
                            })
                            .catch((error) => {
                                alert('Error updating doctor: ' + error);
                            });
                    };
                    addBtn.parentNode.appendChild(updateBtn);
                }
                addBtn.style.display = 'none';
                // Show modal
                const modalEl = document.getElementById('doctorModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modalInstance.show();
            });
        }
    </script>
</body>

</html>