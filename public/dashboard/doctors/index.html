<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/theme-variables.css" rel="stylesheet">
    <link href="../theme/theme-immediate.css" rel="stylesheet">

    <!-- Critical CSS - Apply theme immediately before any rendering -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('easysmile-theme');
            if (savedTheme) {
                const themes = {
                    gold: { bg: 'linear-gradient(135deg, #fff 0%, #ffd700 50%, #fff 100%)', text: '#000', isDark: false },
                    blue: { bg: 'linear-gradient(135deg, #e3f2fd 0%, #007bff 50%, #e3f2fd 100%)', text: '#1a1a1a', isDark: false },
                    green: { bg: 'linear-gradient(135deg, #e8f5e8 0%, #28a745 50%, #e8f5e8 100%)', text: '#1a1a1a', isDark: false },
                    purple: { bg: 'linear-gradient(135deg, #f3e5f5 0%, #6f42c1 50%, #f3e5f5 100%)', text: '#1a1a1a', isDark: false },
                    dark: { bg: 'linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%)', text: '#fff', isDark: true },
                    midnight: { bg: 'linear-gradient(135deg, #0f1419 0%, #1a365d 50%, #0f1419 100%)', text: '#e2e8f0', isDark: true }
                };
                const theme = themes[savedTheme];
                if (theme) {
                    document.documentElement.style.background = theme.bg;
                    const style = document.createElement('style');
                    style.innerHTML = `html, body { background: ${theme.bg} !important; color: ${theme.text} !important; transition: none !important; }`;
                    document.head.appendChild(style);
                    document.documentElement.className = theme.isDark ? 'theme-dark' : 'theme-light';
                }
            }
        })();
    </script>

    <script src="../theme/theme-immediate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../toast.js" defer></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="../theme/theme-manager.js" defer></script>
    <script src="../theme/theme-communication.js" defer></script>

    <style>
        /* Theme-aware styles using CSS custom properties */
        body {
            background: var(--theme-background);
            color: var(--theme-text);
            min-height: 100vh;
        }

        /* Hide page content until theme is fully loaded */
        body.theme-loading .container {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        body:not(.theme-loading) .container {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }

        .btn-primary {
            background: var(--theme-primary-bg);
            border: 2px solid var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--theme-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--theme-shadow);
            color: var(--theme-text);
        }

        .btn-outline-primary {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            background: var(--theme-surface);
        }

        .btn-outline-primary:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .btn-success {
            background: var(--theme-primary-bg);
            border: 2px solid var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
        }

        .btn-success:hover {
            background: var(--theme-accent);
            color: var(--theme-text);
        }

        .form-control {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
        }

        .form-control:focus {
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 0.2rem var(--theme-focus);
            background: var(--theme-surface);
        }

        .form-select {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
        }

        .form-select:focus {
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 0.2rem var(--theme-focus);
            background: var(--theme-surface);
        }

        .table {
            background: var(--theme-surface);
        }

        .table thead {
            background: var(--theme-primary-bg);
        }

        .table thead th {
            background: transparent;
            color: var(--theme-text);
            font-weight: 700;
            border: 2px solid var(--theme-accent);
        }

        .table tbody td {
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
            border-color: var(--theme-accent);
        }

        .table tbody tr:hover {
            background: var(--theme-hover);
        }

        .modal-content {
            background: var(--theme-surface);
        }

        .modal-header {
            background: var(--theme-primary-bg);
            color: var(--theme-text);
            border: none;
        }

        .btn-close {
            filter: var(--theme-close-filter);
            color: var(--theme-text);
        }

        .form-label {
            color: var(--theme-text);
            font-weight: 600;
        }

        h2 {
            color: var(--theme-text);
            font-weight: 700;
        }

        .pagination .page-link {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            background: var(--theme-surface);
        }

        .pagination .page-link:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .pagination .page-item.disabled .page-link {
            background: var(--theme-primary-bg);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .container {
            background: var(--theme-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--theme-shadow);
            padding: 2rem;
        }

        .d-flex.justify-content-between {
            background: var(--theme-highlight-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--theme-accent);
        }
    </style>
</head>

<body style="height: 100%;" id="patients-page" class="theme-loading">

    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Doctors</h2>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#doctorModal">
                Add Doctor
            </button>
        </div>
        <div id="doctorsList"></div>
        <!-- Modal -->
        <div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="doctorModalLabel">Doctor Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <form id="addDoctorForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doctorName" class="form-label">Name</label>
                                        <input type="text" class="form-control" id="doctorName" name="doctorName"
                                            required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorLicense" class="form-label">License No.</label>
                                        <input type="text" class="form-control" id="doctorLicense" name="doctorLicense"
                                            required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorPtrNo" class="form-label">PTR No.</label>
                                        <input type="text" class="form-control" id="doctorPtrNo" name="doctorPtrNo"
                                            required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorGender" class="form-label">Gender</label>
                                        <select class="form-select" id="doctorGender" name="doctorGender" required>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="doctorPosition" class="form-label">Position</label>
                                        <input type="text" class="form-control" id="doctorPosition"
                                            name="doctorPosition" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="doctorStatus" class="form-label">Status</label>
                                        <select class="form-select" id="doctorStatus" name="doctorStatus" required>
                                            <option value="Active">Active</option>
                                            <option value="Inactive">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Add Doctor</button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="  /app.js" defer></script>
    <script>

        // Use localStorage for caching doctors
        let doctors = [];
        let currentPage = 1;
        const pageSize = 15;

        function fetchAndCacheDoctors() {
            if (window.doctorsCollection) {
                window.doctorsCollection.get().then(snapshot => {
                    doctors = [];
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.id = doc.id;
                        doctors.push(d);
                    });
                    // Sort doctors alphabetically by name
                    doctors.sort((a, b) => {
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        if (nameA < nameB) return -1;
                        if (nameA > nameB) return 1;
                        return 0;
                    });
                    localStorage.setItem('cachedDoctors', JSON.stringify(doctors));
                    renderDoctorsTable(currentPage);
                });
            }
        }

        function renderDoctorsTable(page = 1) {
            const totalPages = Math.ceil(doctors.length / pageSize);
            page = Math.max(1, Math.min(page, totalPages));
            currentPage = page;
            let html = `<table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>License No.</th>
                <th>PTR NO.</th>
                <th>Position</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>`;
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, doctors.length);
            for (let i = start; i < end; i++) {
                const d = doctors[i];
                html += `<tr>
            <td>${d.name || ''}</td>
            <td>${d.licenseNo || ''}</td>
            <td>${d.ptrNo || ''}</td>
            <td>${d.position || ''}</td>
            <td>${d.status || 'Active'}</td>
            <td><button class="btn btn-outline-primary btn-sm" onclick="editDoctor('${d.id}')">Edit</button> <button class="btn btn-outline-primary btn-sm" id="deleteDoctorBtn" >Delete</button></td>
        </tr>`;
            }
            html += `</tbody></table>`;
            // Pagination controls (numbered, centered)
            html += `<nav aria-label="Doctors pagination" class="mt-3">
                                <ul class="pagination justify-content-center" style="gap: 8px;">`;
            html += `<li class="page-item">
                                <button class="page-link rounded-pill px-4" id="prevPageBtn">Prev</button>
                            </li>`;
            html += `<li class="page-item disabled">
                                <span class="page-link rounded-pill bg-primary text-white px-4" id="pageInfo" style="color: black !important;">Page ${page} of ${totalPages || 1}</span>
                            </li>`;
            html += `<li class="page-item">
                                <button class="page-link rounded-pill px-4" id="nextPageBtn">Next</button>
                            </li>`;
            html += `</ul></nav>`;
            document.getElementById('doctorsList').innerHTML = html;
            // Add click event for numbered pagination
            // Add click event for pill-style pagination
            const prevBtn = document.querySelector('#doctorsList #prevPageBtn');
            const nextBtn = document.querySelector('#doctorsList #nextPageBtn');
            prevBtn.disabled = page === 1;
            nextBtn.disabled = page === totalPages || totalPages === 0;
            prevBtn.onclick = function (e) {
                e.preventDefault();
                if (page > 1) renderDoctorsTable(page - 1);
            };
            nextBtn.onclick = function (e) {
                e.preventDefault();
                if (page < totalPages) renderDoctorsTable(page + 1);
            };
        }

        document.addEventListener('DOMContentLoaded', function () {
            function deleteDoctor(id) {
                if (!window.doctorsCollection) return;
                if (!id) {
                    showError('No doctor ID provided for deletion.');
                    return;
                }
                if (confirm('Are you sure you want to delete this doctor?')) {
                    window.doctorsCollection.doc(id).delete()
                        .then(() => {
                            showSuccess('Doctor deleted successfully!');
                            // Refresh cached data and re-render
                            fetchAndCacheDoctors();
                        })
                        .catch((error) => {
                            showError('Error deleting doctor: ' + error);
                        });
                }
            }

            // Delegate delete button clicks using event delegation
            document.getElementById('doctorsList').addEventListener('click', function (e) {
                if (e.target && e.target.matches('button[id^="deleteDoctorBtn"]')) {
                    // Find the doctor id from the row
                    const row = e.target.closest('tr');
                    if (row) {
                        // Find the doctor name cell and licenseNo cell to match
                        const nameCell = row.children[0];
                        const licenseCell = row.children[1];
                        const name = nameCell ? nameCell.textContent.trim() : '';
                        const licenseNo = licenseCell ? licenseCell.textContent.trim() : '';
                        // Find the doctor in the cached list
                        const cached = localStorage.getItem('cachedDoctors');
                        let doctors = [];
                        if (cached) {
                            try { doctors = JSON.parse(cached); } catch (e) { doctors = []; }
                        }
                        const doctor = doctors.find(d => d.name === name && d.licenseNo === licenseNo);
                        if (doctor && doctor.id) {
                            deleteDoctor(doctor.id);
                        } else {
                            showError('Could not find doctor ID for deletion.');
                        }
                    }
                }
            });

            // Load cached doctors from localStorage
            const cached = localStorage.getItem('cachedDoctors');
            if (cached) {
                try {
                    doctors = JSON.parse(cached);
                } catch (e) {
                    doctors = [];
                }
            }

            // If no cached data, fetch from Firestore and cache
            if (!doctors || doctors.length === 0) {
                fetchAndCacheDoctors();
            } else {
                renderDoctorsTable(currentPage);
            }

            // Add doctor form submit logic
            const addDoctorForm = document.getElementById('addDoctorForm');
            if (addDoctorForm) {
                addDoctorForm.onsubmit = function (e) {
                    e.preventDefault();
                    function toPascalCase(str) {
                        return str.replace(/\w+/g, function (word) {
                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        });
                    }
                    const rawName = document.getElementById('doctorName').value.trim();
                    const rawLicense = document.getElementById('doctorLicense').value.trim();
                    const rawPtrNo = document.getElementById('doctorPtrNo').value.trim();
                    const gender = document.getElementById('doctorGender').value;
                    const pascalName = toPascalCase(rawName);
                    const doctor = {
                        name: pascalName,
                        licenseNo: rawLicense,
                        ptrNo: rawPtrNo,
                        gender: gender,
                        position: document.getElementById('doctorPosition').value,
                        status: document.getElementById('doctorStatus').value
                    };
                    if (window.doctorsCollection) {
                        // Check for duplicate licenseNo
                        window.doctorsCollection.where('licenseNo', '==', rawLicense).get().then(snapshot => {
                            if (!snapshot.empty) {
                                showError('A doctor with the same License No. already exists!');
                                return;
                            }
                            window.doctorsCollection.add(doctor)
                                .then(() => {
                                    showSuccess('Doctor added successfully!');
                                    addDoctorForm.reset();
                                    // Hide modal
                                    const modalEl = document.getElementById('doctorModal');
                                    const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                    modalInstance.hide();
                                    // Remove modal backdrop if still present
                                    setTimeout(function () {
                                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                                        document.body.classList.remove('modal-open');
                                        document.body.style.overflow = '';
                                    }, 300);
                                    // Refresh cached data and re-render
                                    fetchAndCacheDoctors();
                                })
                                .catch((error) => {
                                    showError('Error adding doctor: ' + error);
                                });
                        });
                    }
                };
                // When modal is closed, restore Add button and remove Update button if present
                document.getElementById('doctorModal').addEventListener('hidden.bs.modal', function () {
                    let addBtn = document.querySelector('#addDoctorForm button[type="submit"]');
                    let updateBtn = document.getElementById('updateDoctorBtn');
                    if (addBtn) addBtn.style.display = 'block';
                    if (updateBtn) updateBtn.remove();
                    addDoctorForm.reset();
                });
            }
        });

        // Edit doctor logic
        function editDoctor(id) {
            if (!window.doctorsCollection) return;
            window.doctorsCollection.doc(id).get().then(doc => {
                if (!doc.exists) {
                    showError('Doctor not found!');
                    return;
                }
                const d = doc.data();
                // Populate modal fields
                document.getElementById('doctorName').value = d.name ? d.name.replace(/^Dr\.?\s*|^Dra\.?\s*/i, '') : '';
                document.getElementById('doctorLicense').value = d.licenseNo || '';
                document.getElementById('doctorGender').value = d.gender || 'Male';
                document.getElementById('doctorPosition').value = d.position || '';
                document.getElementById('doctorStatus').value = d.status || 'Active';
                document.getElementById('doctorPtrNo').value = d.ptrNo || '';
                // Show Update button, hide Add button
                let addBtn = document.querySelector('#addDoctorForm button[type="submit"]');
                let updateBtn = document.getElementById('updateDoctorBtn');
                if (!updateBtn) {
                    updateBtn = document.createElement('button');
                    updateBtn.id = 'updateDoctorBtn';
                    updateBtn.type = 'button';
                    updateBtn.className = 'btn btn-success w-100 mt-2';
                    updateBtn.textContent = 'Update Doctor';
                    updateBtn.onclick = function () {
                        function toPascalCase(str) {
                            return str.replace(/\w+/g, function (word) {
                                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                            });
                        }
                        const rawName = document.getElementById('doctorName').value.trim();
                        const gender = document.getElementById('doctorGender').value;
                        const pascalName = toPascalCase(rawName);
                        const updatedDoctor = {
                            name: pascalName,
                            licenseNo: document.getElementById('doctorLicense').value.trim(),
                            ptrNo: document.getElementById('doctorPtrNo').value.trim(),
                            gender: gender,
                            position: document.getElementById('doctorPosition').value,
                            status: document.getElementById('doctorStatus').value
                        };
                        window.doctorsCollection.doc(id).update(updatedDoctor)
                            .then(() => {
                                showSuccess('Doctor updated successfully!');
                                document.getElementById('addDoctorForm').reset();
                                // Hide modal
                                const modalEl = document.getElementById('doctorModal');
                                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                                modalInstance.hide();
                                // Restore buttons
                                updateBtn.remove();
                                addBtn.style.display = 'block';
                                // Refresh cached data and re-render
                                fetchAndCacheDoctors();
                            })
                            .catch((error) => {
                                showError('Error updating doctor: ' + error);
                                console.error('Error updating doctor: ' + error);
                            });
                    };
                    addBtn.parentNode.appendChild(updateBtn);
                }
                addBtn.style.display = 'none';
                // Show modal
                const modalEl = document.getElementById('doctorModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modalInstance.show();
            });
        }

        // Wait for Firebase to be initialized by app.js (no need to redeclare config)
    </script>
</body>

</html>