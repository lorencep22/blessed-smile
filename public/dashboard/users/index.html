<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users List</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/theme-variables.css" rel="stylesheet">
    <link href="../theme/theme-immediate.css" rel="stylesheet">

    <!-- Critical CSS - Apply theme immediately before any rendering -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('easysmile-theme');
            if (savedTheme) {
                const themes = {
                    gold: { bg: 'linear-gradient(135deg, #fff 0%, #ffd700 50%, #fff 100%)', text: '#000', isDark: false },
                    blue: { bg: 'linear-gradient(135deg, #e3f2fd 0%, #007bff 50%, #e3f2fd 100%)', text: '#1a1a1a', isDark: false },
                    green: { bg: 'linear-gradient(135deg, #e8f5e8 0%, #28a745 50%, #e8f5e8 100%)', text: '#1a1a1a', isDark: false },
                    purple: { bg: 'linear-gradient(135deg, #f3e5f5 0%, #6f42c1 50%, #f3e5f5 100%)', text: '#1a1a1a', isDark: false },
                    dark: { bg: 'linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%)', text: '#fff', isDark: true },
                    midnight: { bg: 'linear-gradient(135deg, #0f1419 0%, #1a365d 50%, #0f1419 100%)', text: '#e2e8f0', isDark: true }
                };
                const theme = themes[savedTheme];
                if (theme) {
                    document.documentElement.style.background = theme.bg;
                    const style = document.createElement('style');
                    style.innerHTML = `html, body { background: ${theme.bg} !important; color: ${theme.text} !important; transition: none !important; }`;
                    document.head.appendChild(style);
                    document.documentElement.className = theme.isDark ? 'theme-dark' : 'theme-light';
                }
            }
        })();
    </script>

    <script src="../theme/theme-immediate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="../theme/theme-manager.js" defer></script>
    <script src="../theme/theme-communication.js" defer></script>

    <style>
        /* Theme-aware styles using CSS custom properties */
        body {
            background: var(--theme-background);
            color: var(--theme-text);
            min-height: 100vh;
        }

        /* Hide page content until theme is fully loaded */
        body.theme-loading .container {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        body:not(.theme-loading) .container {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }

        .btn-primary {
            background: var(--theme-primary-bg);
            border: 2px solid var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--theme-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--theme-shadow);
            color: var(--theme-text);
        }

        .btn-outline-primary {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            background: var(--theme-surface);
        }

        .btn-outline-primary:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .form-control {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
        }

        .form-control:focus {
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 0.2rem var(--theme-focus);
            background: var(--theme-surface);
        }

        .form-select {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
        }

        .form-select:focus {
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 0.2rem var(--theme-focus);
            background: var(--theme-surface);
        }

        .table {
            background: var(--theme-surface);
        }

        .table thead {
            background: var(--theme-primary-bg);
        }

        .table thead th {
            background: transparent;
            color: var(--theme-text);
            font-weight: 700;
            border: 2px solid var(--theme-accent);
        }

        .table tbody td {
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
            border-color: var(--theme-accent);
        }

        .table tbody tr:hover {
            background: var(--theme-hover);
        }

        .modal-content {
            background: var(--theme-surface);
        }

        .modal-header {
            background: var(--theme-primary-bg);
            color: var(--theme-text);
            border: none;
        }

        .btn-close {
            filter: var(--theme-close-filter);
            color: var(--theme-text);
        }

        .form-label {
            color: var(--theme-text);
            font-weight: 600;
        }

        h2 {
            color: var(--theme-text);
            font-weight: 700;
        }

        .pagination .page-link {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            background: var(--theme-surface);
        }

        .pagination .page-link:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .pagination .page-item.disabled .page-link {
            background: var(--theme-primary-bg);
            border-color: var(--theme-accent);
            color: var(--theme-text) !important;
        }

        .container {
            background: var(--theme-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--theme-shadow);
            padding: 2rem;
        }

        .d-flex.justify-content-between {
            background: var(--theme-highlight-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--theme-accent);
        }
    </style>
</head>

<body style="height: 100%;" id="users-page" class="theme-loading">

    <div class="container mt-4">
        <div class="d-flex justify-content-between gap-3 align-items-center mb-2">
            <h2>Users</h2>
            <div class="input-group" style="max-width: 400px; margin-left: auto;">
                <input type="text" class="form-control" id="searchUserInput" placeholder="Search by user name..."
                    list="userNamesDatalist">
                <button type="button" class="btn btn-primary" id="searchUserBtn">Search</button>
            </div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">
                Add User
            </button>
        </div>

        <div id="usersList"></div>

        <!-- Modal -->
        <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">User Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- Dynamic content goes here -->
                    </div>
                    <!-- <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div> -->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../toast.js" defer></script>
    <script src="../../app.js" defer></script>
    <script>

        const usersPage = document.getElementById("users-page");
        document.addEventListener('DOMContentLoaded', function () {
            // Generate user form inside modal
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `
                            <form id="addUserForm">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="fullName" class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="fullName" required placeholder="Enter full name">
                                        </div>
                                        <div class="mb-3">
                                            <label for="googleEmail" class="form-label">Google Email</label>
                                            <input type="email" class="form-control" id="googleEmail" required placeholder="Enter Google email address">
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Add User</button>
                            </form>
                        `;

            // Confirmation and submit logic
            const addUserForm = document.getElementById('addUserForm');
            addUserForm.onsubmit = function (e) {
                e.preventDefault();
                if (confirm('Are you sure you want to add this new user?')) {
                    const fullName = document.getElementById('fullName').value.trim();
                    const googleEmail = document.getElementById('googleEmail').value.trim().toLowerCase();

                    // Validate email format
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(googleEmail)) {
                        showError('Please enter a valid email address.');
                        return;
                    }

                    // Check for duplicate user by email (only among users with role 'user')
                    window.usersCollection
                        .where('googleEmail', '==', googleEmail)
                        .where('role', '==', 'user')
                        .get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                showError('A user with this email already exists!');
                                return;
                            }

                            const user = {
                                fullName: fullName,
                                googleEmail: googleEmail,
                                createdAt: new Date().toISOString(),
                                role: 'user'
                            };

                            window.usersCollection.add(user)
                                .then(() => {
                                    showSuccess('User added successfully!');
                                    document.getElementById('addUserForm').reset();
                                    // Hide modal
                                    const modalEl = document.getElementById('userModal');
                                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                                    modal.hide();
                                    // Remove modal backdrop if still present
                                    setTimeout(function () {
                                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                                        document.body.classList.remove('modal-open');
                                        document.body.style.overflow = '';
                                    }, 300);
                                    // Dispatch event to update cached data and table
                                    window.dispatchEvent(new Event('newUserAdded'));
                                })
                                .catch((error) => {
                                    showError('Error adding user: ' + error);
                                });
                        })
                        .catch((error) => {
                            showError('Error checking for duplicate user: ' + error);
                        });
                }
            };

            // Render users table after global collections are set
            setTimeout(function () {
                if (usersPage && window.usersCollection) {
                    // Try to load cached users from localStorage
                    let users = [];
                    const cached = localStorage.getItem('cachedUsers');
                    if (cached) {
                        try {
                            users = JSON.parse(cached);
                        } catch (e) {
                            users = [];
                        }
                    }
                    // Pagination variables
                    let currentPage = 1;
                    const pageSize = 10;
                    const totalPages = Math.ceil(users.length / pageSize);

                    function fetchAndCacheUsers() {
                        window.usersCollection.where('role', '==', 'user').get().then((snapshot) => {
                            users = [];
                            snapshot.forEach((doc) => {
                                const user = doc.data();
                                user.id = doc.id;
                                users.push(user);
                            });
                            // Sort users alphabetically by full name
                            users.sort((a, b) => {
                                const nameA = a.fullName.toLowerCase();
                                const nameB = b.fullName.toLowerCase();
                                if (nameA < nameB) return -1;
                                if (nameA > nameB) return 1;
                                return 0;
                            });
                            localStorage.setItem('cachedUsers', JSON.stringify(users));
                            renderTable(currentPage);
                        });
                    }

                    // If no cached data, fetch from Firestore and cache
                    if (!users || users.length === 0) {
                        fetchAndCacheUsers();
                    } else {
                        // Sort cached users alphabetically
                        users.sort((a, b) => {
                            const nameA = a.fullName.toLowerCase();
                            const nameB = b.fullName.toLowerCase();
                            if (nameA < nameB) return -1;
                            if (nameA > nameB) return 1;
                            return 0;
                        });
                        renderTable(currentPage);
                    }

                    function renderTable(page, filteredUsers = null) {
                        const usersList = document.getElementById("usersList");
                        usersList.innerHTML = "";
                        let html = `<table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Full Name</th>
                      <th>Google Email</th>
                      <th>Created Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>`;
                        const data = filteredUsers || users;
                        const start = (page - 1) * pageSize;
                        const end = Math.min(start + pageSize, data.length);
                        for (let i = start; i < end; i++) {
                            const u = data[i];
                            const createdDate = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A';
                            html += `<tr>
                    <td>${u.fullName}</td>
                    <td>${u.googleEmail}</td>
                    <td>${createdDate}</td>
                    <td><button class="btn btn-outline-danger btn-sm" onclick="deleteUser('${u.id}', '${u.fullName}')">Delete</button></td>
                  </tr>`;
                        }
                        html += `</tbody></table>`;

                        // Pagination controls (pill-style)
                        const totalFilteredPages = Math.ceil(data.length / pageSize);
                        html += `<nav aria-label="Users pagination" class="mt-3">
                                                            <ul class="pagination justify-content-center" style="gap: 8px;">`;
                        html += `<li class="page-item">
                                                            <button class="page-link rounded-pill px-4" id="prevPageBtn">Prev</button>
                                                        </li>`;
                        html += `<li class="page-item disabled">
                                                            <span class="page-link rounded-pill bg-primary text-white px-4" id="pageInfo">Page ${page} of ${totalFilteredPages || 1}</span>
                                                        </li>`;
                        html += `<li class="page-item">
                                                            <button class="page-link rounded-pill px-4" id="nextPageBtn">Next</button>
                                                        </li>`;
                        html += `</ul></nav>`;

                        usersList.innerHTML = html;

                        // Add click event for pagination pill buttons
                        const prevBtn = usersList.querySelector("#prevPageBtn");
                        const nextBtn = usersList.querySelector("#nextPageBtn");
                        prevBtn.disabled = page === 1;
                        nextBtn.disabled = page === totalFilteredPages || totalFilteredPages === 0;
                        prevBtn.onclick = (e) => {
                            e.preventDefault();
                            if (page > 1) renderTable(page - 1, filteredUsers);
                        };
                        nextBtn.onclick = (e) => {
                            e.preventDefault();
                            if (page < totalFilteredPages) renderTable(page + 1, filteredUsers);
                        };
                    }

                    // Search logic
                    const searchBtn = document.getElementById('searchUserBtn');
                    const searchInput = document.getElementById('searchUserInput');
                    if (searchBtn && searchInput) {
                        searchBtn.addEventListener('click', function () {
                            const searchTerm = searchInput.value.trim().toLowerCase();
                            if (!searchTerm) {
                                renderTable(1); // Show all users
                                return;
                            }
                            // Filter users by name or email
                            const filteredUsers = users.filter(u =>
                                u.fullName.toLowerCase().includes(searchTerm) ||
                                u.googleEmail.toLowerCase().includes(searchTerm)
                            );
                            if (filteredUsers.length === 0) {
                                showWarning('No users found matching your search.');
                                return;
                            }
                            renderTable(1, filteredUsers);
                        });

                        // Allow search on Enter key
                        searchInput.addEventListener('keypress', function (e) {
                            if (e.key === 'Enter') {
                                searchBtn.click();
                            }
                        });
                    }

                    // Listen for new user addition to refresh cache
                    window.addEventListener('newUserAdded', function () {
                        fetchAndCacheUsers();
                    });

                    // Delete user function
                    window.deleteUser = function (userId, userName) {
                        if (confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                            window.usersCollection.doc(userId).delete()
                                .then(() => {
                                    showSuccess('User deleted successfully!');
                                    // Remove from cache and refresh table
                                    users = users.filter(u => u.id !== userId);
                                    localStorage.setItem('cachedUsers', JSON.stringify(users));
                                    renderTable(currentPage);
                                })
                                .catch((error) => {
                                    showError('Error deleting user: ' + error);
                                });
                        }
                    };
                }
            }, 200);
        });

        // Wait for Firebase to be initialized by app.js (no need to redeclare config)
    </script>
</body>

</html>