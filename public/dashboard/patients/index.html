<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>

<body style="height: 100%;" id="patients-page">

    <div class="container mt-4">
        <div class="d-flex justify-content-between gap-3 align-items-center mb-2">
            <h2>Patients</h2>
            <div class="input-group" style="max-width: 400px; margin-left: auto;">
                <input type="text" class="form-control" id="searchPatientInput" placeholder="Search by patient name..."
                    list="patientNamesDatalist">
                <button type="button" class="btn btn-primary" id="searchPatientBtn">Search</button>
            </div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#patientModal">
                Add Patient
            </button>
        </div>

        <div id="patientsList"></div>
        <!-- Modal -->
        <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="patientModalLabel">Patient Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- Dynamic content goes here -->
                    </div>
                    <!-- <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div> -->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="  /app.js" defer></script>
    <script>
        const patientsPage = document.getElementById("patients-page");
        document.addEventListener('DOMContentLoaded', function () {
            // Generate patient form inside modal
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `
                            <form id="addPatientForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="firstName" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="firstName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="middleName" class="form-label">Middle Name</label>
                                            <input type="text" class="form-control" id="middleName">
                                        </div>
                                        <div class="mb-3">
                                            <label for="lastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="lastName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="sex" class="form-label">Gender</label>
                                            <select class="form-select" id="sex" required>
                                                <option value="">Select</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="contactNo" class="form-label">Contact No.</label>
                                            <input type="text" class="form-control" id="contactNo" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="address" class="form-label">Address</label>
                                            <input type="text" class="form-control" id="address">
                                        </div>
                                        <div class="mb-3">
                                            <label for="birthday" class="form-label">Birthday</label>
                                            <input type="date" class="form-control" id="birthday">
                                        </div>
                                        <div class="mb-3">
                                            <label for="occupation" class="form-label">Occupation</label>
                                            <input type="text" class="form-control" id="occupation">
                                        </div>
                                        <div class="mb-3">
                                            <label for="civilStatus" class="form-label">Civil Status</label>
                                            <select class="form-select" id="civilStatus">
                                                <option value="">Select</option>
                                                <option value="Single">Single</option>
                                                <option value="Married">Married</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Submit</button>
                            </form>
                        `;

            // Confirmation and submit logic
            const addPatientForm = document.getElementById('addPatientForm');
            addPatientForm.onsubmit = function (e) {
                e.preventDefault();
                if (confirm('Are you sure you want to submit this new patient?')) {
                    function toPascalCase(str) {
                        return str.replace(/\w+/g, function (word) {
                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        });
                    }
                    const firstNameRaw = document.getElementById('firstName').value.trim();
                    const middleNameRaw = document.getElementById('middleName').value.trim();
                    const lastNameRaw = document.getElementById('lastName').value.trim();
                    const firstName = toPascalCase(firstNameRaw);
                    const middleName = toPascalCase(middleNameRaw);
                    const lastName = toPascalCase(lastNameRaw);
                    // Check for duplicate patient
                    window.patientDetailsCollection
                        .where('firstName', '==', firstName)
                        .where('middleName', '==', middleName)
                        .where('lastName', '==', lastName)
                        .get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                alert('A patient with the same name already exists!');
                                return;
                            }
                            const patient = {
                                firstName,
                                middleName,
                                lastName,
                                sex: document.getElementById('sex').value,
                                contactNo: document.getElementById('contactNo').value,
                                email: document.getElementById('email').value,
                                address: document.getElementById('address').value,
                                birthday: document.getElementById('birthday').value,
                                occupation: document.getElementById('occupation').value,
                                civilStatus: document.getElementById('civilStatus').value
                            };
                            window.patientDetailsCollection.add(patient)
                                .then(() => {
                                    alert('Patient added successfully!');
                                    document.getElementById('addPatientForm').reset();
                                    // Hide modal
                                    const modalEl = document.getElementById('patientModal');
                                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                                    modal.hide();
                                    // Remove modal backdrop if still present
                                    setTimeout(function () {
                                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                                        document.body.classList.remove('modal-open');
                                        document.body.style.overflow = '';
                                    }, 300);
                                    // Optionally, reload the page or refresh the patient list
                                    generatePatientNamesDatalist();
                                    // Dispatch event to update cached data and table
                                    window.dispatchEvent(new Event('newPatientAdded'));
                                })
                                .catch((error) => {
                                    alert('Error adding patient: ' + error);
                                });
                        });
                }
            };

            // Render patients table after global collections are set
            setTimeout(function () {
                if (patientsPage && window.patientDetailsCollection) {
                    // Try to load cached patients from localStorage
                    let patients = [];
                    const cached = localStorage.getItem('cachedPatients');
                    if (cached) {
                        try {
                            patients = JSON.parse(cached);
                        } catch (e) {
                            patients = [];
                        }
                    }
                    // Pagination variables
                    let currentPage = 1;
                    const pageSize = 10;
                    const totalPages = Math.ceil(patients.length / pageSize);

                    function fetchAndCachePatients() {
                        window.patientDetailsCollection.get().then((snapshot) => {
                            patients = [];
                            snapshot.forEach((doc) => {
                                const patient = doc.data();
                                patient.id = doc.id;
                                patients.push(patient);
                            });
                            // Sort patients alphabetically by full name
                            patients.sort((a, b) => {
                                const nameA = `${a.firstName} ${a.middleName} ${a.lastName}`.toLowerCase();
                                const nameB = `${b.firstName} ${b.middleName} ${b.lastName}`.toLowerCase();
                                if (nameA < nameB) return -1;
                                if (nameA > nameB) return 1;
                                return 0;
                            });
                            localStorage.setItem('cachedPatients', JSON.stringify(patients));
                            renderTable(currentPage);
                        });
                    }

                    // If no cached data, fetch from Firestore and cache
                    if (!patients || patients.length === 0) {
                        fetchAndCachePatients();
                    } else {
                        // Sort cached patients alphabetically
                        patients.sort((a, b) => {
                            const nameA = `${a.firstName} ${a.middleName} ${a.lastName}`.toLowerCase();
                            const nameB = `${b.firstName} ${b.middleName} ${b.lastName}`.toLowerCase();
                            if (nameA < nameB) return -1;
                            if (nameA > nameB) return 1;
                            return 0;
                        });
                        renderTable(currentPage);
                    }

                    function renderTable(page, filteredPatients = null) {
                        const patientsList = document.getElementById("patientsList");
                        patientsList.innerHTML = "";
                        let html = `<table class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>Full Name</th>
                      <th>Gender</th>
                      <th>Contact No.</th>
                      <th>Email</th>
                      <th>Accounts</th>
                    </tr>
                  </thead>
                  <tbody>`;
                        const data = filteredPatients || patients;
                        const start = (page - 1) * pageSize;
                        const end = Math.min(start + pageSize, data.length);
                        for (let i = start; i < end; i++) {
                            const p = data[i];
                            html += `<tr>
                    <td>${p.firstName} ${p.middleName} ${p.lastName}</td>
                    <td>${p.sex}</td>
                    <td>${p.contactNo}</td>
                    <td>${p.email}</td>
                    <td ><a class="btn btn-outline-primary btn-sm" target="_blank" href="/dashboard/patients/profile.html?id=${p.id}">View</a></td>
                  </tr>`;
                        }
                        html += `</tbody></table>`;

                        // Pagination controls (pill-style)
                        const totalFilteredPages = Math.ceil(data.length / pageSize);
                        html += `<nav aria-label="Patients pagination" class="mt-3">
                                                            <ul class="pagination justify-content-center" style="gap: 8px;">`;
                        html += `<li class="page-item">
                                                            <button class="page-link rounded-pill px-4" id="prevPageBtn">Prev</button>
                                                        </li>`;
                        html += `<li class="page-item disabled">
                                                            <span class="page-link rounded-pill bg-primary text-white px-4" id="pageInfo">Page ${page} of ${totalFilteredPages || 1}</span>
                                                        </li>`;
                        html += `<li class="page-item">
                                                            <button class="page-link rounded-pill px-4" id="nextPageBtn">Next</button>
                                                        </li>`;
                        html += `</ul></nav>`;

                        patientsList.innerHTML = html;

                        // Add click event for pagination pill buttons
                        const prevBtn = patientsList.querySelector("#prevPageBtn");
                        const nextBtn = patientsList.querySelector("#nextPageBtn");
                        prevBtn.disabled = page === 1;
                        nextBtn.disabled = page === totalFilteredPages || totalFilteredPages === 0;
                        prevBtn.onclick = (e) => {
                            e.preventDefault();
                            if (page > 1) renderTable(page - 1, filteredPatients);
                        };
                        nextBtn.onclick = (e) => {
                            e.preventDefault();
                            if (page < totalFilteredPages) renderTable(page + 1, filteredPatients);
                        };
                    }

                    // Search logic
                    const searchBtn = document.getElementById('searchPatientBtn');
                    const searchInput = document.getElementById('searchPatientInput');
                    if (searchBtn && searchInput) {
                        searchBtn.addEventListener('click', function () {
                            const name = searchInput.value.trim();
                            if (!name) {
                                alert('Please enter or select a patient name.');
                                searchInput.focus();
                                return;
                            }
                            // Validate against datalist
                            const datalist = document.getElementById('patientNamesDatalist');
                            const matches = datalist ? Array.from(datalist.options).filter(opt => opt.value === name) : [];
                            if (matches.length === 0) {
                                alert('Please select a valid patient name from the list.');
                                searchInput.focus();
                                return;
                            }
                            // Filter patients by full name
                            const filteredPatients = patients.filter(p => `${p.firstName} ${p.middleName} ${p.lastName}` === name);
                            if (filteredPatients.length === 0) {
                                alert('No patient found with that name.');
                                return;
                            }
                            renderTable(1, filteredPatients);
                        });
                    }

                    // Listen for new patient addition to refresh cache
                    window.addEventListener('newPatientAdded', function () {
                        fetchAndCachePatients();
                    });
                }
            }, 200);
        });
    </script>
</body>

</html>