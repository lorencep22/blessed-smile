<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients List</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/theme-variables.css" rel="stylesheet">
    <link href="../theme/theme-immediate.css" rel="stylesheet">

    <!-- Critical CSS - Apply theme immediately before any rendering -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('easysmile-theme');
            if (savedTheme) {
                const themes = {
                    gold: { bg: 'linear-gradient(135deg, #fff 0%, #ffd700 50%, #fff 100%)', text: '#000', isDark: false },
                    blue: { bg: 'linear-gradient(135deg, #e3f2fd 0%, #007bff 50%, #e3f2fd 100%)', text: '#1a1a1a', isDark: false },
                    green: { bg: 'linear-gradient(135deg, #e8f5e8 0%, #28a745 50%, #e8f5e8 100%)', text: '#1a1a1a', isDark: false },
                    purple: { bg: 'linear-gradient(135deg, #f3e5f5 0%, #6f42c1 50%, #f3e5f5 100%)', text: '#1a1a1a', isDark: false },
                    dark: { bg: 'linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%)', text: '#fff', isDark: true },
                    midnight: { bg: 'linear-gradient(135deg, #0f1419 0%, #1a365d 50%, #0f1419 100%)', text: '#e2e8f0', isDark: true }
                };
                const theme = themes[savedTheme];
                if (theme) {
                    document.documentElement.style.background = theme.bg;
                    const style = document.createElement('style');
                    style.innerHTML = `html, body { background: ${theme.bg} !important; color: ${theme.text} !important; transition: none !important; }`;
                    document.head.appendChild(style);
                    document.documentElement.className = theme.isDark ? 'theme-dark' : 'theme-light';
                }
            }
        })();
    </script>

    <script src="../theme/theme-immediate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../toast.js" defer></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="../theme/theme-manager.js" defer></script>
    <script src="../theme/theme-communication.js" defer></script>

    <style>
        /* Theme-aware styles using CSS custom properties */
        body {
            background: var(--theme-background);
            color: var(--theme-text);
            min-height: 100vh;
        }

        /* Hide page content until theme is fully loaded */
        body.theme-loading .container {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        body:not(.theme-loading) .container {
            opacity: 1;
            transition: opacity 0.3s ease-in;
        }

        .btn-primary {
            background: var(--theme-primary-bg);
            border: 2px solid var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--theme-accent);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--theme-shadow);
            color: var(--theme-text);
        }

        .btn-outline-primary {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            background: var(--theme-surface);
        }

        .btn-outline-primary:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .form-control {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
        }

        .form-control:focus {
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 0.2rem var(--theme-focus);
            background: var(--theme-surface);
        }

        .form-select {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
        }

        .form-select:focus {
            border-color: var(--theme-accent);
            box-shadow: 0 0 0 0.2rem var(--theme-focus);
            background: var(--theme-surface);
        }

        .table {
            background: var(--theme-surface);
        }

        .table thead {
            background: var(--theme-primary-bg);
        }

        .table thead th {
            background: transparent;
            color: var(--theme-text);
            font-weight: 700;
            border: 2px solid var(--theme-accent);
        }

        .table tbody td {
            color: var(--theme-text);
            font-weight: 500;
            background: var(--theme-surface);
            border-color: var(--theme-accent);
        }

        .table tbody tr:hover {
            background: var(--theme-hover);
        }

        .modal-content {
            background: var(--theme-surface);
        }

        .modal-header {
            background: var(--theme-primary-bg);
            color: var(--theme-text);
            border: none;
        }

        .btn-close {
            filter: var(--theme-close-filter);
            color: var(--theme-text);
        }

        .form-label {
            color: var(--theme-text);
            font-weight: 600;
        }

        h2 {
            color: var(--theme-text);
            font-weight: 700;
        }

        .pagination .page-link {
            border-color: var(--theme-accent);
            color: var(--theme-text);
            font-weight: 600;
            background: var(--theme-surface);
        }

        .pagination .page-link:hover {
            background: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text);
        }

        .pagination .page-item.disabled .page-link {
            background: var(--theme-primary-bg);
            border-color: var(--theme-accent);
            color: var(--theme-text) !important;
        }

        .container {
            background: var(--theme-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 16px var(--theme-shadow);
            padding: 2rem;
        }

        .d-flex.justify-content-between {
            background: var(--theme-highlight-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--theme-accent);
        }

        /* Responsive Design Breakpoints */

        /* Mobile First Approach - Base styles for mobile */
        .header-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
            margin-bottom: 1rem;
        }

        .header-title {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .search-container {
            width: 100%;
            max-width: none;
        }

        .add-patient-btn {
            width: 100%;
            padding: 0.75rem;
        }

        /* Table Responsive Styles */
        .responsive-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--theme-shadow);
        }

        .responsive-table {
            min-width: 600px;
        }

        .responsive-th,
        .responsive-td {
            white-space: nowrap;
            padding: 0.75rem 0.5rem;
        }

        /* Hide columns on smaller screens */
        .hide-on-mobile {
            display: none;
        }

        .hide-on-small {
            display: none;
        }

        .hide-on-tablet {
            display: table-cell;
        }

        /* Modal Responsive */
        .responsive-modal {
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }

        .responsive-modal-content {
            border-radius: 12px;
        }

        .responsive-form-row {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Container padding adjustments */
        .container {
            padding: 1rem;
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }

        /* Pagination responsive */
        .pagination {
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .page-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Small devices (landscape phones, 576px and up) */
        @media (min-width: 576px) {
            .hide-on-mobile {
                display: table-cell;
            }

            .container {
                padding: 1.5rem;
                margin: 1rem auto;
                max-width: 540px;
            }

            .header-controls {
                flex-direction: row;
                align-items: center;
            }

            .add-patient-btn {
                width: auto;
                min-width: 140px;
            }

            .search-container {
                flex: 1;
                max-width: 350px;
            }

            .responsive-th,
            .responsive-td {
                padding: 0.75rem;
            }
        }

        /* Medium devices (tablets, 768px and up) */
        @media (min-width: 768px) {
            .hide-on-small {
                display: table-cell;
            }

            .container {
                max-width: 720px;
                padding: 2rem;
            }

            .header-section {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .header-title {
                text-align: left;
                margin-bottom: 0;
            }

            .header-controls {
                flex-direction: row;
                width: auto;
                justify-content: flex-end;
            }

            .search-container {
                max-width: 400px;
                margin-right: 1rem;
            }

            .responsive-modal {
                margin: 1.75rem auto;
                max-width: 500px;
            }

            .responsive-form-row {
                flex-direction: row;
            }

            .responsive-form-row .col-md-6 {
                flex: 1;
            }
        }

        /* Large devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .container {
                max-width: 960px;
            }

            .responsive-table {
                min-width: 100%;
            }

            .responsive-modal {
                max-width: 600px;
            }
        }

        /* Extra large devices (large desktops, 1200px and up) */
        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }

        /* Extra extra large devices (1400px and up) */
        @media (min-width: 1400px) {
            .container {
                max-width: 1320px;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                padding: 0.75rem 1rem;
                font-size: 1rem;
                min-height: 44px;
                touch-action: manipulation;
            }

            .page-link {
                padding: 0.75rem 1rem;
                min-height: 44px;
                touch-action: manipulation;
            }

            .form-control,
            .form-select {
                padding: 0.75rem;
                font-size: 1rem;
                min-height: 44px;
                touch-action: manipulation;
            }

            .table td,
            .table th {
                padding: 1rem 0.5rem;
            }
        }

        /* Additional responsive utilities */
        .text-responsive {
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .text-responsive {
                font-size: 1rem;
            }
        }

        /* Responsive button sizes */
        .btn-responsive {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .btn-responsive {
                padding: 0.625rem 1.25rem;
                font-size: 1rem;
            }
        }

        /* Ensure proper spacing on mobile */
        .gap-responsive {
            gap: 0.5rem;
        }

        @media (min-width: 576px) {
            .gap-responsive {
                gap: 0.75rem;
            }
        }

        @media (min-width: 768px) {
            .gap-responsive {
                gap: 1rem;
            }
        }
    </style>
</head>

<body style="height: 100%;" id="patients-page" class="theme-loading">

    <div class="container mt-4">
        <div class="header-section gap-responsive">
            <h2 class="header-title">Patients</h2>
            <div class="header-controls gap-responsive">
                <div class="input-group search-container">
                    <input type="text" class="form-control" id="searchPatientInput"
                        placeholder="Search by patient name..." list="patientNamesDatalist">
                    <button type="button" class="btn btn-primary btn-responsive" id="searchPatientBtn">Search</button>
                </div>
                <button type="button" class="btn btn-primary add-patient-btn btn-responsive" data-bs-toggle="modal"
                    data-bs-target="#patientModal">
                    Add Patient
                </button>
            </div>
        </div>

        <div id="patientsList"></div>

        <!-- Datalist for search suggestions -->
        <datalist id="patientNamesDatalist">
            <!-- Options will be populated dynamically by JavaScript -->
        </datalist>

        <!-- Modal -->
        <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
            <div class="modal-dialog responsive-modal">
                <div class="modal-content responsive-modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="patientModalLabel">Patient Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- Dynamic content goes here -->
                    </div>
                    <!-- <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div> -->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../app.js" defer></script>
    <script>
        const patientsPage = document.getElementById("patients-page");
        document.addEventListener('DOMContentLoaded', function () {
            // Generate patient form inside modal
            const modalBody = document.getElementById('modalBody');

            modalBody.innerHTML = `
                            <form id="addPatientForm">
                                <div class="responsive-form-row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="firstName" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="firstName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="middleName" class="form-label">Middle Name</label>
                                            <input type="text" class="form-control" id="middleName">
                                        </div>
                                        <div class="mb-3">
                                            <label for="lastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="lastName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="sex" class="form-label">Gender</label>
                                            <select class="form-select" id="sex" required>
                                                <option value="">Select</option>
                                                <option value="Male">Male</option>
                                                <option value="Female">Female</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="contactNo" class="form-label">Contact No.</label>
                                            <input type="text" class="form-control" id="contactNo" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="address" class="form-label">Address</label>
                                            <input type="text" class="form-control" id="address">
                                        </div>
                                        <div class="mb-3">
                                            <label for="birthday" class="form-label">Birthday</label>
                                            <input type="date" class="form-control" id="birthday">
                                        </div>
                                        <div class="mb-3">
                                            <label for="occupation" class="form-label">Occupation</label>
                                            <input type="text" class="form-control" id="occupation">
                                        </div>
                                        <div class="mb-3">
                                            <label for="civilStatus" class="form-label">Civil Status</label>
                                            <select class="form-select" id="civilStatus">
                                                <option value="">Select</option>
                                                <option value="Single">Single</option>
                                                <option value="Married">Married</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Submit</button>
                            </form>
                        `;

            // Confirmation and submit logic
            const addPatientForm = document.getElementById('addPatientForm');
            addPatientForm.onsubmit = function (e) {
                e.preventDefault();
                if (confirm('Are you sure you want to submit this new patient?')) {
                    function toPascalCase(str) {
                        return str.replace(/\w+/g, function (word) {
                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        });
                    }
                    const firstNameRaw = document.getElementById('firstName').value.trim();
                    const middleNameRaw = document.getElementById('middleName').value.trim();
                    const lastNameRaw = document.getElementById('lastName').value.trim();
                    const firstName = toPascalCase(firstNameRaw);
                    const middleName = toPascalCase(middleNameRaw);
                    const lastName = toPascalCase(lastNameRaw);
                    // Check for duplicate patient
                    window.patientDetailsCollection
                        .where('firstName', '==', firstName)
                        .where('middleName', '==', middleName)
                        .where('lastName', '==', lastName)
                        .get()
                        .then(snapshot => {
                            if (!snapshot.empty) {
                                showError('A patient with the same name already exists!');
                                return;
                            }
                            const patient = {
                                firstName,
                                middleName,
                                lastName,
                                sex: document.getElementById('sex').value,
                                contactNo: document.getElementById('contactNo').value,
                                email: document.getElementById('email').value,
                                address: document.getElementById('address').value,
                                birthday: document.getElementById('birthday').value,
                                occupation: document.getElementById('occupation').value,
                                civilStatus: document.getElementById('civilStatus').value
                            };
                            window.patientDetailsCollection.add(patient)
                                .then(() => {
                                    showSuccess('Patient added successfully!');
                                    document.getElementById('addPatientForm').reset();
                                    // Hide modal
                                    const modalEl = document.getElementById('patientModal');
                                    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                                    modal.hide();
                                    // Remove modal backdrop if still present
                                    setTimeout(function () {
                                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                                        document.body.classList.remove('modal-open');
                                        document.body.style.overflow = '';
                                    }, 300);
                                    // Optionally, reload the page or refresh the patient list
                                    generatePatientNamesDatalist();
                                    // Dispatch event to update cached data and table
                                    window.dispatchEvent(new Event('newPatientAdded'));
                                })
                                .catch((error) => {
                                    showError('Error adding patient: ' + error);
                                });
                        });
                }
            };

            // Render patients table after global collections are set
            setTimeout(function () {
                if (patientsPage && window.patientDetailsCollection) {
                    // Try to load cached patients from localStorage
                    let patients = [];
                    const cached = localStorage.getItem('cachedPatients');
                    if (cached) {
                        try {
                            patients = JSON.parse(cached);
                        } catch (e) {
                            patients = [];
                        }
                    }
                    // Pagination variables
                    let currentPage = 1;
                    const pageSize = 10;
                    const totalPages = Math.ceil(patients.length / pageSize);

                    function generatePatientNamesDatalist() {
                        const datalist = document.getElementById('patientNamesDatalist');
                        if (!datalist) return;

                        datalist.innerHTML = '';
                        patients.forEach(patient => {
                            const option = document.createElement('option');
                            option.value = `${patient.firstName} ${patient.middleName} ${patient.lastName}`;
                            datalist.appendChild(option);
                        });
                    }

                    function fetchAndCachePatients() {
                        window.patientDetailsCollection.get().then((snapshot) => {
                            patients = [];
                            snapshot.forEach((doc) => {
                                const patient = doc.data();
                                patient.id = doc.id;
                                patients.push(patient);
                            });
                            // Sort patients alphabetically by full name
                            patients.sort((a, b) => {
                                const nameA = `${a.firstName} ${a.middleName} ${a.lastName}`.toLowerCase();
                                const nameB = `${b.firstName} ${b.middleName} ${b.lastName}`.toLowerCase();
                                if (nameA < nameB) return -1;
                                if (nameA > nameB) return 1;
                                return 0;
                            });
                            localStorage.setItem('cachedPatients', JSON.stringify(patients));
                            generatePatientNamesDatalist();
                            renderTable(currentPage);
                        });
                    }

                    // If no cached data, fetch from Firestore and cache
                    if (!patients || patients.length === 0) {
                        fetchAndCachePatients();
                    } else {
                        // Sort cached patients alphabetically
                        patients.sort((a, b) => {
                            const nameA = `${a.firstName} ${a.middleName} ${a.lastName}`.toLowerCase();
                            const nameB = `${b.firstName} ${b.middleName} ${b.lastName}`.toLowerCase();
                            if (nameA < nameB) return -1;
                            if (nameA > nameB) return 1;
                            return 0;
                        });
                        generatePatientNamesDatalist();
                        renderTable(currentPage);
                    }

                    function renderTable(page, filteredPatients = null) {
                        const patientsList = document.getElementById("patientsList");
                        patientsList.innerHTML = "";
                        let html = `<div class="responsive-table-container">
                            <table class="table table-bordered table-hover responsive-table">
                  <thead>
                    <tr>
                      <th class="responsive-th">Full Name</th>
                      <th class="responsive-th hide-on-small">Gender</th>
                      <th class="responsive-th hide-on-mobile">Contact No.</th>
                      <th class="responsive-th hide-on-small">Email</th>
                      <th class="responsive-th">Actions</th>
                    </tr>
                  </thead>
                  <tbody>`;
                        const data = filteredPatients || patients;
                        const start = (page - 1) * pageSize;
                        const end = Math.min(start + pageSize, data.length);
                        for (let i = start; i < end; i++) {
                            const p = data[i];
                            html += `<tr>
                    <td class="responsive-td">${p.firstName} ${p.middleName} ${p.lastName}</td>
                    <td class="responsive-td hide-on-small">${p.sex}</td>
                    <td class="responsive-td hide-on-mobile">${p.contactNo}</td>
                    <td class="responsive-td hide-on-small">${p.email}</td>
                    <td class="responsive-td"><a class="btn btn-outline-primary btn-sm" target="_blank" href="/dashboard/patients/profile.html?id=${p.id}">View</a></td>
                  </tr>`;
                        }
                        html += `</tbody></table></div>`;

                        // Pagination controls (pill-style)
                        const totalFilteredPages = Math.ceil(data.length / pageSize);
                        html += `<nav aria-label="Patients pagination" class="mt-3">
                                                            <ul class="pagination justify-content-center" style="gap: 8px;">`;
                        html += `<li class="page-item">
                                                            <button class="page-link rounded-pill px-4" id="prevPageBtn">Prev</button>
                                                        </li>`;
                        html += `<li class="page-item disabled">
                                                            <span class="page-link rounded-pill bg-primary text-white px-4" id="pageInfo">Page ${page} of ${totalFilteredPages || 1}</span>
                                                        </li>`;
                        html += `<li class="page-item">
                                                            <button class="page-link rounded-pill px-4" id="nextPageBtn">Next</button>
                                                        </li>`;
                        html += `</ul></nav>`;

                        patientsList.innerHTML = html;

                        // Add click event for pagination pill buttons
                        const prevBtn = patientsList.querySelector("#prevPageBtn");
                        const nextBtn = patientsList.querySelector("#nextPageBtn");
                        prevBtn.disabled = page === 1;
                        nextBtn.disabled = page === totalFilteredPages || totalFilteredPages === 0;
                        prevBtn.onclick = (e) => {
                            e.preventDefault();
                            if (page > 1) renderTable(page - 1, filteredPatients);
                        };
                        nextBtn.onclick = (e) => {
                            e.preventDefault();
                            if (page < totalFilteredPages) renderTable(page + 1, filteredPatients);
                        };
                    }

                    // Search logic
                    const searchBtn = document.getElementById('searchPatientBtn');
                    const searchInput = document.getElementById('searchPatientInput');
                    if (searchBtn && searchInput) {
                        searchBtn.addEventListener('click', function () {
                            const name = searchInput.value.trim();
                            if (!name) {
                                showWarning('Please enter or select a patient name.');
                                searchInput.focus();
                                return;
                            }
                            // Validate against datalist
                            const datalist = document.getElementById('patientNamesDatalist');
                            const matches = datalist ? Array.from(datalist.options).filter(opt => opt.value === name) : [];
                            if (matches.length === 0) {
                                showWarning('Please select a valid patient name from the list.');
                                searchInput.focus();
                                return;
                            }
                            // Filter patients by full name
                            const filteredPatients = patients.filter(p => `${p.firstName} ${p.middleName} ${p.lastName}` === name);
                            if (filteredPatients.length === 0) {
                                showError('No patient found with that name.');
                                return;
                            }
                            renderTable(1, filteredPatients);
                        });
                    }

                    // Listen for new patient addition to refresh cache
                    window.addEventListener('newPatientAdded', function () {
                        fetchAndCachePatients();
                    });
                }
            }, 200);
        });

        // Wait for Firebase to be initialized by app.js (no need to redeclare config)
    </script>
</body>

</html>